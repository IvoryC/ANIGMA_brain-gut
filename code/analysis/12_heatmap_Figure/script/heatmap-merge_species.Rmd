---
title: "Heatmap Figure"
output: html_document
date: "2024-02-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r}
outDir = "../output"
dir.create(outDir)
```

## 

Set up the outline of desired rows/columns for the heatmap.

Desired rows.
```{r}
metrics = c("Shannon Diversity",
            "Richness")

# names of elements are the manual labels.  
# element values should match the row names of the species-level heat map and p-value table from module 05_Taxonomy_vs_Features.
species = c("(genus) Ruminococcus" = "g__Ruminococcus (UB*)[3]" ,
            "(species) Ruminococcus torques group" = "g__.Ruminococcus._torques_group (UB*)[72]" ,
            "(species) Ruminococcus gnavus group" = ".Ruminococcus._gnavus_group.[134]" ,
            "(genus) Oscillibacter" = "g__Oscillibacter (UB*)[152]" ,
            "(genus) Phascolarctobacterium" = "g__Phascolarctobacterium (UB*)[67]" ,
            "(genus) Uncultured genus in the Oscillospiraceae family" = "g__uncultured (UB*)[34]",
            "(genus) Bifidobacterium" = "Bifidobacterium.[2]",
            "(genus) Cloacibacillus" = "Cloacibacillus.[173]",
            "(genus) Clostridium sensu stricto" = "Clostridium_sensu_stricto_2.[66]" ,
            "(genus) Faecalibacterium" = "Faecalibacterium.[14]",
            "(genus) Akkermansia" = "g__Akkermansia (UB*)[23]",
            "(genus) Lachnoclostridium" = "g__Lachnoclostridium (UB*)[97]",
            "(genus) Lachnospira" = "g__Lachnospira (UB*)[46]" ,
            "(genus) Holdemania" = "Holdemania.[117]",
            "(family) Lachnospiraceae" = "Lachnospiraceae.[22]" ,
            "(genus) Parabacteroides" = "Parabacteroides.[29]",
            "(species) Streptococcus" = "Streptococcus_sp.[33]",
            "(genus) Roseburia" = "g__Roseburia (UB*)[19]",
            "(genus) Romboutsia" = "g__Romboutsia (UB*)[90]",
            "(genus) Methanobrevibacter" = "Methanobrevibacter.[69]")

write.table(cbind(shown=names(species), original=species), 
            file=file.path(outDir, "selected_taxa.txt"), 
            sep="\t", row.names=F)
```

Desired columns.
```{r}
cols = c('HC AD'="ANOREXIA.HCT1.anova", 
         'HC DIS'="ANOREXIA.HCT2.anova", 
         'DIS vs AD' = "TIMEPOINT.T1T2.pairedT",
         'DIS vs AD (ACUTE)' = "TIMEPOINT.T1T2.pairedT.acute",
         'DIS vs AD (CEED)' = "TIMEPOINT.T1T2.pairedT.ceed",
         'DIS vs AD (Fargo)' = "TIMEPOINT.T1T2.pairedT.fargo",
         'Subtype AD'="SUBTYPE.AN.HCT1.anova", 
         'Subtype DIS'="SUBTYPE.AN.HCT2.anova", 
         'Location AD'="LOCATION.HCT1.anova", 
         'Location DIS'="LOCATION.HCT2.anova", 
         'Weight AD'="Weight_kg.T1.pearson", 
         'Weight DIS'="Weight_kg.T2.pearson", 
         'BMI AD'="BMI.T1.pearson", 
         'BMI DIS'="BMI.T2.pearson", 
         'PSS AD'="PSS.T1.pearson", 
         'PSS DIS'="PSS.T2.pearson", 
         'State Anxiety AD'="STAI_Y1.T1.pearson", 
         'State Anxiety DIS'="STAI_Y1.T2.pearson", 
         'State Anxiety change'="STAI_Y1.diff.T1.pearson", 
         'Trait Anxiety AD'="STAI_Y2.T1.pearson", 
         'Trait Anxiety DIS'="STAI_Y2.T2.pearson",
         'Trait Anxiety change'="STAI_Y2.diff.T1.pearson"
         )

write.table(cbind(shown=names(cols), original=cols), 
            file=file.path(outDir, "selected_tests.txt"), 
            sep="\t", row.names=F)
```


Get the Diversity metrics.
```{r}
diversity = read.delim2("../../08.1_Diversity_vs_Features/output/species/bigList_pvalues_fdr-adjusted_species.txt")
row.names(diversity) = diversity$taxon
diversity = diversity[c("shannon.diversity", "richness"),]
row.names(diversity) = c("Shannon Diversity", "Richness")

# diversity$TIMEPOINT.T1T2.pairedT = NA
```

Get the taxonomy metrics.
```{r}
taxa = read.delim2("../../05_Taxonomy_vs_Features/output/species/bigList_pvalues_fdr-adjusted_species.txt")

# select desired rows
row.names(taxa) = taxa$taxon
taxa = taxa[species, ]

#rename rows
row.names(taxa) = names(species)
```

Put them together.
```{r}
forHeat = rbind(diversity[ ,cols],
                taxa[ ,cols])
names(forHeat) = names(cols)
forHeat = forHeat %>% 
    mutate_if(is.character, as.numeric) %>%
    mutate_if(is.numeric, function(x){x[x > 0.05] = 1; return(x)})

write.table(cbind(labels=names(forHeat), forHeat), 
            file=file.path(outDir, "heatmap_values.txt"), 
            sep="\t", row.names=F)
```


Heat map function.
```{r}
# source("../../05_Taxonomy_vs_Features/")

pvalTableToHeatMap = function(pvalTable, taxaLevel, midpointPval=0.05, bluePvalue=0.05, redPvalue=0.00001, title="-log10(p-values)", displayName.FUN=c, caption.notes=""){
    # pvalTable - data frame of pvalues, with columns corresponding to variables (metadata) and named rows for taxa_metrics.
    # bluePval - pvalues worse than this will all be shown in blue.
    # midpointPval - these will be shown in white, as a middle point between the blue and red gradients.
    # all p-values better than this will be shown in solid red.
    pvalTable[pvalTable < redPvalue] = redPvalue
    pvalTable[pvalTable > bluePvalue] = bluePvalue
    
    taxon = sapply( row.names(pvalTable), displayName.FUN )
    if (length(unique(taxon)) < nrow(pvalTable)){
        taxon = paste0(taxon, "[", 1:nrow(pvalTable), "]")
    }
    row.names(pvalTable) = taxon
    
    longTab = -log10(pvalTable) %>% 
        mutate(taxon= row.names(pvalTable) ) %>%
        pivot_longer(cols=-taxon, names_to = "var", values_to="pval")
    longTab$var = factor(x=as.character(longTab$var), levels=names(pvalTable))
    longTab$taxon = factor(x=as.character(longTab$taxon), levels=row.names(pvalTable))
    ggplot(longTab, aes(x=var, y=taxon, fill=pval)) +
      geom_tile(col="gray") +
      scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                           midpoint = -log10(midpointPval),
                           limit = c(-log10(bluePvalue),-log10(redPvalue)),
                           space = "Lab",
                           # name=paste0("p-value threshold: ", midpointPval, "\n\n-log10(p-value)"),
                           name="-log10(p-value)",
                           na.value = gray(.9)) +
      theme_minimal()+ # minimal theme
      ggtitle(title) +
      xlab("") +
      ylab("") +
      theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                       size = 8, hjust = 1)) +
      coord_fixed() +
      labs(caption=caption.notes)
}
```

```{r}
pvalTableToHeatMap(forHeat,midpointPval=0.1, bluePvalue=0.1,
                   title="-log10(adjusted p-values)",
                   caption.notes = "species level")
```

Save to pdf.
```{r}
pdf(file.path(outDir, "heatMap_main_fig.pdf"))

show(last_plot())

dev.off()
```


TODO
```{r}
# See url: https://www.tutorialspoint.com/how-to-write-partial-title-of-x-axis-in-italics-using-ggplot2-of-r
#.  expression(paste("X comes from ",italic("normal distribution")))
```

